<!DOCTYPE html>
<html>

<head>
    <title>IIIF Image Viewer</title>
    <link rel="stylesheet" href="iiif.css">
    <!-- <link rel="stylesheet" href="annotorious.css"> -->
    <link rel="stylesheet" href="../styles/shared_styles.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.14/dist/annotorious.min.css">
    <link href="https://fonts.googleapis.com/css?family=Barlow+Condensed:100,200,300,400,500,600&display=swap"
        rel="stylesheet" />
    <script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.14/dist/openseadragon-annotorious.min.js"></script>
    <script type="text/javascript" src="../mesh/js/jquery.js"></script>
</head>

<style>
    #currentpage {
        font-family: "Oswald", sans-serif !important;
        color: white;
        font-size: 0.8em !important;
        font-weight: 100;
        pointer-events: none !important;
    }
</style>

<body>
    <!-- Container for OpenSeadragon -->
    <div id="openseadragon" style="width: 100%; height: calc(100vh); background-color:black"></div>
    <!-- <button onclick="viewAnnotations()">View Annotations</button>
        <div id="annotationsJson" style="white-space: pre;"></div> -->

    <!--  <div class="ui-overlay-container" style="height:300px; z-index:1000; pointer-events:none; ">

        <div id="instructions" style="bottom:100px; width:255px; display:none;">
            <div class="instruction-closer" onclick="$('#instructions').hide();"></div>
            Hold shift and click-and-drag to mark <br> the inscription you wish to annotate.
        </div>
    </div>
 -->
    <!--confirm annotation-->
    <!--   <div id="savePopup" class="popup">
        <div class="popup-content">
            <p>Are you satisfied with the selection?</p>
            <button id="saveYes">It is correct</button>
            <button id="saveNo">Redo the selection</button>
        </div>
    </div> -->

    <div class="interface-area">
        <div id="ToolbarHorizontal">

            <a id="prev-button">
                <div id="Prev" class="NavButton"></div>
            </a>
            <span id="currentpage"></span>
            <a id="next-button">
                <div id="Next" class="NavButton"></div>
            </a>
        </div>
        <div class="toolbar-bottom">

            <a id="home" href="#home">
                <div id="Home" class="NavButton"></div>
            </a>

            <a id="zoom-in" href="#zoom-in">
                <div id="ZoomIn" class="NavButton"></div>
            </a>
            <a id="zoom-out" href="#zoom-out">
                <div id="ZoomOut" class="NavButton"></div>
            </a>
            <a id="full-page" href="#full-page">
                <div id="FullPage" class="NavButton"></div>
            </a>
        </div>
        <a id="download" target="_blank">
            <div id="" class="download-button" title="Download image"></div>
        </a>

        <div class="guide-button" title="User Guide" onclick="$('#instructions').css('transform', 'scale(0.0)'); $('#guide').css('pointer-events', 'auto');$('#guide').css('opacity', '1.0');$('#guide-instructions-tools').css('transform', 'scale(1.0)');">?</div>
    </div>

    <script>
        //var anno;
        OpenSeadragon.supportsFullScreen = false;
        OpenSeadragon.supportsFullPage = true;

        function saveViewerState(viewer) {
            var zoomLevel = viewer.viewport.getZoom();
            var centerPoint = viewer.viewport.getCenter();
            var state = {
                zoom: zoomLevel,
                center: { x: centerPoint.x, y: centerPoint.y }
            };
            localStorage.setItem('viewerState', JSON.stringify(state));
        }

        function getSavedViewerState() {
            var state = localStorage.getItem('viewerState');
            return state ? JSON.parse(state) : null;
        }

        window.onload = function () {
            var isInitialLoad = true;
            var savedState = getSavedViewerState();

            var tileSourcesString = 'PLACEHOLDER_IIIF_IMAGE_URLS';
            //var downloadSourceString = 'PLACEHOLDER_JPG_IMAGE_URLS';
            var tileSources = JSON.parse(tileSourcesString); // Convert the JSON string back to an array
            // var downloadSources = JSON.parse(downloadSourceString);

            // document.getElementById('download').addEventListener('click', function(event) {
            //     event.preventDefault();
            //     const pageIndex = viewer.currentPage();
            //     const imageUrl = downloadSources[pageIndex];

            //     fetch(imageUrl)
            //         .then(response => response.blob())
            //         .then(blob => {
            //             const url = window.URL.createObjectURL(blob);
            //             const filename = `image_${pageIndex + 1}.jpg`;
            //             const a = document.createElement('a');
            //             a.style.display = 'none';
            //             a.href = url;
            //             a.download = filename;
            //             document.body.appendChild(a);
            //             a.click();
            //             window.URL.revokeObjectURL(url);
            //             document.body.removeChild(a);
            //         })
            //         .catch(() => console.error("Could not download the image"));
            // });

            function getPageUrl(pageIndex) {
                var baseImageUrl = "https://img.dh.gu.se/saintsophia/static/inscriptions/iiif";
                var imageId = tileSources[pageIndex].split('/')[7];
                return `${baseImageUrl}/${imageId}/full/full/0/default.jpg`;
            }

            function updateDownloadLink(pageIndex) {
                var downloadLink = document.getElementById("download");
                downloadLink.href = getPageUrl(pageIndex);
            }

            var viewer = OpenSeadragon({
                id: "openseadragon",
                prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
                tileSources: tileSources,
                immediateRender: false,
                visibilityRatio: 1.0,
                minZoomImageRatio: 0.85,
                homeFillsViewer: false,
                showZoomControl: true,
                showHomeControl: true,
                showFullPageControl: true,
                showNavigator: true,
                preserveViewport: true,
                navigatorAutoFade: true,
                sequenceMode: true,
                fullPageButton: "full-page",
                zoomInButton: "zoom-in",
                zoomOutButton: "zoom-out",
                nextButton: "next-button",
                previousButton: "prev-button",
                homeButton: "home",

            });

            viewer.addHandler('open', function () {
                if (isInitialLoad && savedState) {
                    viewer.viewport.zoomTo(savedState.zoom);
                    viewer.viewport.panTo(new OpenSeadragon.Point(savedState.center.x, savedState.center.y));
                    document.getElementById("currentpage").innerHTML = "1 of " + tileSources.length;
                    updateDownloadLink(0);
                    isInitialLoad = false;
                }
            });

            viewer.addHandler('viewport-change', function () {
                saveViewerState(viewer);
            });

            viewer.addHandler("page", function (data) {
                var pageIndex = data.page;
                document.getElementById("currentpage").innerHTML = (pageIndex + 1) + " of " + tileSources.length;
                updateDownloadLink(pageIndex);
            });

            /*    // Initialize the Annotorious plugin
               anno = OpenSeadragon.Annotorious(viewer, {
                   // Additional configuration options
                   disableEditor: true
   
               }); */

            /*  anno.on('createSelection', async function (selection) {
 
                 // Tag to insert
                 selection.body = [{
                     type: 'TextualBody',
                     purpose: 'tagging',
                     value: 'MyTag'
                 }];
 
                 // Step 3: update the selection and save it
                 // Remember that .updateSelected is an async function!
                 // You need to wait until it completes before saving
                 await anno.updateSelected(selection);
                 anno.saveSelected();
 
                 // Alternative:
                 // anno.updateSelected(selection, true);
             }); */

            // Load annotations in W3C WebAnnotation format
            //anno.loadAnnotations('annotations.w3c.json');

            // Attach handlers to listen to events
            /*     anno.on('createAnnotation', function (annotation) {
                    // Show the popup
                    document.getElementById('savePopup').style.display = 'block';
                    document.getElementById('instructions').style.display = 'none';
    
                    // Handle Yes button click
                    document.getElementById('saveYes').onclick = function() {
                        console.log('Annotation coordinates:', annotation.target.selector.value);
                        document.getElementById('savePopup').style.display = 'none';
                    };
    
                    // Handle No button click
                    document.getElementById('saveNo').onclick = function() {
                        anno.removeAnnotation(annotation.id);
                        document.getElementById('savePopup').style.display = 'none';
                    };
                }); */

            /*   anno.on('clickAnnotation', function (annotation, element) {
                  const annotationData = {
                      type: 'annotationClick',
                      value: annotation.body[0].value
                  }; */

            //send a message to the parent window (index.html) with the annotation data
            //window.parent.postMessage(annotationData, "*");

        };

        // function viewAnnotations() {
        //     var annotations = anno.getAnnotations();
        //     var annotationsJson = JSON.stringify(annotations, null, 2); // Pretty print the JSON

        //     console.log(annotationsJson); // Log to console

        //     // Alternatively, display in an element on the page
        //     document.getElementById('annotationsJson').textContent = annotationsJson;
        // }
    </script>

<div id="guide" onclick="$('#guide').css('pointer-events', 'none');$('#guide').css('opacity', '0.0');$('#guide-instructions-tools').css('transform', 'scale(0.5)');">
    <div class="guide-content">
        <!-- <h1>User Guide: <br>Spatial Context</h1> -->
        <div class="guide-instructions">
            <div class="guide-instructions-intro">
                
                Scroll to zoom in and out. Click and drag to pan the view. <br>
                Use the arrows above the toolbar to browse between different analytical layers.
                
            </div>

            <div id="guide-instructions-tools">
                <h2>Tools</h2>
                <div class="guide-instructions-item">
                    <div class="guide-instructions-item-icon"
                        style="background-image:url(../styles/interface/frame.png)"></div>
                    <div class="guide-instructions-item-label">
                        <p>Frame object.</p> Changes the view to the original position.
                    </div>
                </div>

                <div class="guide-instructions-item">
                    <div class="guide-instructions-item-icon"
                        style="background-image:url(../styles/interface/expand.svg)"></div>
                    <div class="guide-instructions-item-label">
                        <p>Full screen.</p> Activates full screen mode. Click ESC to exit.
                    </div>
                </div>

                <div class="guide-closer">Close</div>
            </div>
        </div>
    </div>
</div>

</body>

</html>